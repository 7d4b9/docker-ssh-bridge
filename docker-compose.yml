networks:
  dockernet:
   driver: bridge
services:
  ssh-docker-server:
    image: ${IMAGE:-dbndev/ssh-bridge}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ${SSH_PUBLIC_KEY:-./id_rsa.pub}:/home/devuser/.ssh/authorized_keys/id_rsa.pub
    ports:
      - 22022:22
    networks:
      dockernet:
        aliases:
        - proxy

  ssh-docker-server-proxy:
    image: ${IMAGE:-dbndev/ssh-bridge}
    depends_on:
      - ssh-docker-server
    ports:
      - 23750:23750
    volumes:
      - ${SSH_PRIVATE_KEY:-./id_rsa}:/home/devuser/.ssh/authorized_keys/id_rsa}
    environment: 
      DOCKER_HOST: 0.0.0.0:23750
    command: |
      bash -c '
      bash -c "
        while ! nc -z ssh_server ${SSH_SERVER_PORT:-22}; do sleep 1; done;
        ssh -i ${SSH_PRIVATE_KEY:-/home/devuser/.ssh/authorized_keys/id_rsa} -N -L 23750:/var/run/docker.sock user1@ssh_server
      "
      ssh -NL $${DOCKER_HOST}:/var/run/docker.sock $${USER}@${SSH_DOCKER_SERVER:-ssh-docker-server}
      #socat TCP-LISTEN:23750,fork,reuseaddr TCP:$${DOCKER_HOST} > /tmp/socat-ssh-docker-server-2375/0.log 2>&1 &
      #sleep 1000
      '
    networks:
      dockernet:
        aliases:
        - proxy

  ssh-docker-consumer:
    image: ${IMAGE:-dbndev/ssh-bridge}
    depends_on:
      - ssh-docker-server-proxy
    environment:
      - DOCKER_HOST=ssh-docker-server-proxy:23750
    command: |
      bash -c "
      until docker version; do echo Waiting docker over client provider; done
      "
    networks:
      dockernet:
        aliases:
        - consumer
